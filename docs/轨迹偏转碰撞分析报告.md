# PA-LOI v33 ç³»ç»Ÿå…¨æ™¯åˆ†æ & è½¨è¿¹åè½¬ç¢°æ’è¯Šæ–­

> **åœºæ™¯**: ghost_experiment.json (ID: 199456, 34 agents)
> **æ—¥æœŸ**: 2026-02-11
> **ç‰ˆæœ¬**: PA-LOI v33

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç¢°æ’é—®é¢˜è¯Šæ–­

### 1.1 é—®é¢˜æè¿°

åœ¨ PA-LOI v33 å¯¹ç…§å®éªŒï¼ˆæ— é¬¼æ¢å¤´ï¼‰ä¸­ï¼Œego è½¦è¾†æˆåŠŸé€šè¿‡é®æŒ¡ç‰© 199456 åï¼Œåœ¨ **Frame 415 (t=8.3s)** å¤„è½¨è¿¹å‘ç”Ÿå‰§çƒˆåè½¬ï¼Œæ‰€æœ‰è§„åˆ’è½¨è¿¹æœå³ä¾§åœé è½¦è¾† 199437 åç§»ï¼Œæœ€ç»ˆåœ¨ **Frame 427 (t=8.54s)** ä»¥ **5.0 m/s** çš„é€Ÿåº¦ç¢°æ’ã€‚

### 1.2 ç¢°æ’å…³é”®æ•°æ®

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| ç¢°æ’æ—¶é—´ | t=8.54s (Frame 427) |
| Ego é€Ÿåº¦ | 4.996 m/s |
| Ego ä½ç½® | (3071.63, 1525.24) |
| Ego æœå‘ | -0.213 rad (å³å ~12Â°) |
| ç¢°æ’ç›®æ ‡ | 199437 (é™æ­¢è½¦è¾†, vâ‰ˆ0) |
| 199437 ä½ç½® | (3075.82, 1522.94) |

### 1.3 å…³é”®å¸§æ¼”å˜

````carousel
![Frame 390 (v=4.28 m/s) â€” è½¨è¿¹æ­£ç¡®ï¼Œæ²¿è½¦é“ç›´è¡Œ](../output/ghost_experiment/improved/imgs/frame_390.png)
<!-- slide -->
![Frame 405 (v=4.54 m/s) â€” è½¨è¿¹ä»æ­£ç¡®ï¼Œä½†å·²æ¥è¿‘ 199437](../output/ghost_experiment/improved/imgs/frame_405.png)
<!-- slide -->
![Frame 410 (v=4.67 m/s) â€” è½¨è¿¹å¼€å§‹å¾®åå³](../output/ghost_experiment/improved/imgs/frame_410.png)
<!-- slide -->
![Frame 415 (v=4.78 m/s) â€” âš ï¸ è½¨è¿¹ä¸¥é‡åè½¬ï¼æœ 199437 å†²å»](../output/ghost_experiment/improved/imgs/frame_415.png)
<!-- slide -->
![Frame 420 (v=4.91 m/s) â€” âŒ è½¨è¿¹å®Œå…¨æ‰­æ›²ï¼ŒU å‹å¼¯å†²å‘å³ä¾§](../output/ghost_experiment/improved/imgs/frame_420.png)
````

### 1.4 æ ¹å› åˆ†æ

iLQR è§„åˆ’å™¨é€šè¿‡ä¸‰ç§åŠ›å†³å®šè½¨è¿¹ï¼Œåœ¨ Frame 415 åŠ›åœºå¹³è¡¡è¢«æ‰“ç ´ï¼š

```mermaid
graph LR
    A["ğŸŸ¢ è½¦é“å¸å¼•åŠ›<br/>w_tgt Ã— åç¦»Â²"] -->|æ‹‰å‘è½¦é“ä¸­å¿ƒçº¿| D["iLQR è¾“å‡º"]
    B["ğŸ”´ exo æ’æ–¥åŠ›<br/>w_exo Ã— è·ç¦»åœº"] -->|æ¨ç¦»éšœç¢ç‰©| D
    C["ğŸŸ¡ PA-LOI é£é™©åŠ›<br/>VelocityAwareRiskPotential"] -->|é€Ÿåº¦åˆ¶åŠ¨| D
    style B fill:#ff6b6b
```

| åŠ› | æ–¹å‘ | é—®é¢˜ |
|----|------|------|
| è½¦é“å¸å¼•åŠ› `w_tgt=1.0` | æœå³ä¸Šæ–¹ï¼ˆç»è¿‡ 199437 é™„è¿‘ï¼‰ | è½¦é“å‚è€ƒçº¿æ°å¥½ç»è¿‡ 199437 |
| éšœç¢ç‰©æ’æ–¥åŠ› `w_exo=10.0` | è¿œç¦» 199437 | **æ’æ–¥èŒƒå›´åªæœ‰ ~2.5mï¼Œä¸è¶³ä»¥åœ¨ 5m/s ä¸‹é˜²ç¢°** |
| PA-LOI é£é™©åŠ› | å‡é€Ÿ | 199437 ä¸æ˜¯é¬¼æ¢å¤´å€™é€‰ï¼ŒPA-LOI ä¸å¤„ç† |

#### æ’æ–¥åŠ›ä¸è¶³çš„ä¸‰ä¸ªå­é—®é¢˜

**é—®é¢˜ â‘ ï¼šé™æ­¢è½¦è¾†åæ–¹å·®æå°**

SIMPL å¯¹é™æ­¢è½¦è¾†çš„é¢„æµ‹åæ–¹å·®æ¥è¿‘ 0ï¼Œæœ‰æ•ˆæ’æ–¥åŠå¾„åªæœ‰ï¼š

```
æœ‰æ•ˆæ’æ–¥åŠå¾„ = covs (â‰ˆ0) + w_exo_cov_offset (2.5) = 2.5m
```

ä»¥ 5.0 m/s æ¥è¿‘æ—¶ï¼Œ2.5m åªæœ‰ **0.5s** çš„ååº”è·ç¦»ã€‚

**é—®é¢˜ â‘¡ï¼šæ’æ–¥åŠ›æ˜¯è½¯çº¦æŸ**

æ’æ–¥åŠ›é€šè¿‡ `w_exo_cost_offset = 10.0` å åŠ åˆ° cost ä¸­ï¼Œè¿™æ˜¯æ¯å¸§æŒ‰åœºæ™¯æ ‘åŠ æƒçš„ã€‚å½“è½¦é“å‚è€ƒçº¿ç›´æ¥ç©¿è¿‡ 199437 é™„è¿‘æ—¶ï¼Œè½¦é“å¸å¼•åŠ›çš„å¤§æ¢¯åº¦ä½¿ iLQR **ä¼˜å…ˆå›å½’è½¦é“**ã€‚

**é—®é¢˜ â‘¢ï¼šæ’æ–¥èŒƒå›´æœ‰é™**

`exo_dis_field` åªåœ¨è·ç¦» < `exo_cov + 2.5m` æ—¶æœ‰æ•ˆã€‚>2.5m æ—¶æ’æ–¥åŠ›ä¸º 0ï¼ŒiLQR å®Œå…¨çœ‹ä¸åˆ°å‰æ–¹éšœç¢ã€‚

> [!IMPORTANT]
> è¿™ä¸æ˜¯ PA-LOI å¼•å…¥çš„ bugï¼Œè€Œæ˜¯ MIND æ¡†æ¶çš„**å›ºæœ‰å±€é™**ã€‚åŸå§‹ MIND åœ¨ç›¸åŒåœºæ™¯ä¸‹ä¹Ÿä¼šå‘ç”Ÿç¢°æ’ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šPA-LOI v33 ç³»ç»Ÿå…¨æ™¯

### 2.1 ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```mermaid
flowchart TD
    subgraph "æ„ŸçŸ¥å±‚ Perception"
        A["Agent Observations<br/>(ä½ç½®/é€Ÿåº¦/ç±»å‹)"] --> B["get_semantic_risk_sources()"]
        B --> B1["ç±»å‹ç­›é€‰"]
        B1 --> B2["é€Ÿåº¦ç­›é€‰"]
        B2 --> B3["åŠ¨æ€èµ°å»Šç­›é€‰"]
        B3 --> B4["ç›®æ ‡è½¦é“ç­›é€‰"]
        B4 --> B5["è§†çº¿åˆ‡ç‚¹ç®—æ³•"]
        B5 --> B6["TTA çŠ¶æ€æœº"]
        B6 --> C["Risk Sources<br/>é£é™©æºåˆ—è¡¨"]
    end

    subgraph "è§„åˆ’å±‚ Planning"
        C --> D["MIND iLQR Planner"]
        D --> D1["init_cost_tree()"]
        D1 --> D2["exo_dis_field<br/>éšœç¢ç‰©è·ç¦»åœº"]
        D1 --> D3["VelocityAwareRiskPotential<br/>PA-LOI é€Ÿåº¦åŠ¿åœº"]
        D2 --> D4["iLQR Solve"]
        D3 --> D4
        D4 --> E["Trajectory Tree<br/>è½¨è¿¹æ ‘"]
    end

    subgraph "å®‰å…¨å±‚ Safety Shield"
        E --> F["RSS AEB"]
        F --> F1["TTC è®¡ç®—"]
        F1 --> F2["RSS å®‰å…¨è·ç¦»"]
        F2 --> F3["ä¸‰çº§åˆ¶åŠ¨<br/>WARNING/DANGER/CRITICAL"]
        F3 --> F4["Hysteresis çŠ¶æ€æœº"]
        F4 --> G["Final Control<br/>(acc, steer)"]
    end

    subgraph "è®°å½•å±‚ Logging"
        G --> H["PALOIDataLogger<br/>CSV + Plot"]
    end

    style D3 fill:#ff9800
    style F fill:#f44336,color:#fff
```

### 2.2 å…¨å±€å¼€å…³

å®šä¹‰åœ¨ [planner.py](file:///Users/phy/Desktop/MIND/planners/mind/planner.py#L14-L31)ï¼š

| å¼€å…³ | é»˜è®¤å€¼ | ä½œç”¨ |
|------|--------|------|
| `ENABLE_GHOST_PROBE` | `True` | é¬¼æ¢å¤´æ£€æµ‹æ€»å¼€å…³ |
| `ENABLE_AEB` | `True` | AEB å®‰å…¨æŠ¤ç›¾æ€»å¼€å…³ |
| `ENABLE_DATA_LOGGING` | `True` | CSV å®éªŒæ—¥å¿— |
| `DEBUG_LOG_ENABLED` | `True` | æ§åˆ¶å°è°ƒè¯•è¾“å‡º |

```python
# planner.py L14-31
ENABLE_GHOST_PROBE = True
ENABLE_AEB = True
ENABLE_DATA_LOGGING = True
DEBUG_LOG_ENABLED = True
```

---

### 2.3 æ¨¡å—ä¸€ï¼šåŠ¨æ€èµ°å»Š (Dynamic Corridor)

**æ–‡ä»¶**: [utils.py](file:///Users/phy/Desktop/MIND/planners/mind/utils.py#L561-L597) `calculate_adaptive_corridor()`

**åŸç†**ï¼šåŸºäºè½¦é“å®½åº¦å’Œè½¦é€ŸåŠ¨æ€è®¡ç®—**åŒå±‚èµ°å»Šè¾¹ç•Œ**ï¼Œæ›¿ä»£å›ºå®šé˜ˆå€¼ã€‚

```mermaid
graph LR
    subgraph "èµ°å»Šç»“æ„"
        A["d_critical<br/>å†…å±‚ç¦åŒº"] --- B["d_outer<br/>å¤–å±‚æ„ŸçŸ¥"]
    end
```

**å‚æ•°**ï¼š

| å‚æ•° | å…¬å¼ | è¯´æ˜ |
|------|------|------|
| `EGO_WIDTH` | 2.0m | è½¦èº«å®½åº¦ |
| `SAFETY_MARGIN` | 0.2m | å®‰å…¨ä½™é‡ |
| `d_critical` | `min(0.5 + 0.03v, lane/2 - 0.2)` | å†…å±‚ç»å¯¹ç¦åŒº |
| `d_outer` | `min(5.0, road/2)` | å¤–å±‚æ„ŸçŸ¥èŒƒå›´ |

**ä»£ç **ï¼š

```python
# utils.py L561-597
def calculate_adaptive_corridor(lane_width, road_width, ego_vel):
    EGO_WIDTH = 2.0
    SAFETY_MARGIN = 0.2
    
    # å†…å±‚ (d_critical) = åŠ¨åŠ›å­¦éœ€æ±‚ vs å‡ ä½•çº¦æŸ å–è¾ƒå°å€¼
    dynamic_need = 0.5 + 0.03 * abs(ego_vel)
    geometric_limit = (lane_width / 2.0) - SAFETY_MARGIN
    d_critical = min(dynamic_need, geometric_limit)
    d_critical = max(d_critical, 0.2)  # å…œåº•
    
    # å¤–å±‚ (d_outer) = ç‰©ç†è¾¹ç•Œçº¦æŸ
    physical_boundary = road_width / 2.0
    d_outer = min(5.0, physical_boundary)
    d_outer = max(d_outer, d_critical + 0.5)
    
    return d_critical, d_outer
```

**å®æµ‹å€¼**ï¼ˆlane=3.5m, v=2.4m/sï¼‰ï¼š`d_critical=0.57m, d_outer=3.50m`

---

### 2.4 æ¨¡å—äºŒï¼šè¯­ä¹‰é£é™©æºè¯†åˆ« (Semantic Risk Source Detection)

**æ–‡ä»¶**: [utils.py](file:///Users/phy/Desktop/MIND/planners/mind/utils.py#L759-L1027) `get_semantic_risk_sources()`

**åŸç†**ï¼šé€šè¿‡å¤šçº§ç­›é€‰æµæ°´çº¿ï¼Œä»æ‰€æœ‰ agent ä¸­è¯†åˆ«å¯èƒ½æ„æˆ"é¬¼æ¢å¤´"å¨èƒçš„é®æŒ¡ç‰©ã€‚

#### ç­›é€‰æµæ°´çº¿

```mermaid
flowchart TD
    A["æ‰€æœ‰ Agent (Nä¸ª)"] --> B{"ç±»å‹ç­›é€‰<br/>VEHICLE/BUS?"}
    B -->|å¦| X1["âŒ NOT_OCCLUDER_TYPE"]
    B -->|æ˜¯| C{"é€Ÿåº¦ç­›é€‰<br/>speed < 0.5 m/s?"}
    C -->|å¦| X2["âŒ MOVING"]
    C -->|æ˜¯| D{"çºµå‘ç­›é€‰<br/>-5m < long < 50m?"}
    D -->|å¦| X3["âŒ BEHIND/TOO_FAR"]
    D -->|æ˜¯| E{"èµ°å»Šç­›é€‰<br/>lat < d_outer?"}
    E -->|å¦| X4["âŒ OUT_OF_CORRIDOR"]
    E -->|æ˜¯| F{"ç›®æ ‡è½¦é“ç­›é€‰<br/>åœ¨ç›®æ ‡è½¦é“ä¸Š?"}
    F -->|å¦| X5["âŒ NOT_ON_TARGET_LANE"]
    F -->|æ˜¯| G["âœ… é€šè¿‡ï¼<br/>â†’ è§†çº¿åˆ‡ç‚¹ â†’ TTA æƒé‡"]
```

#### ç­›é€‰å‚æ•°

| ç­›é€‰å™¨ | å‚æ•° | å€¼ | è¯´æ˜ |
|--------|------|-----|------|
| ç±»å‹ | å…è®¸ç±»å‹ | VEHICLE, BUS | åªæœ‰è½¦è¾†/å…¬äº¤å¯åšé®æŒ¡ç‰© |
| é€Ÿåº¦ | `STATIC_SPEED_THRES` | 0.5 m/s | é«˜äºæ­¤é€Ÿåº¦è§†ä¸ºç§»åŠ¨ä¸­ |
| çºµå‘ | æœ€å°å€¼ | -5.0m | å…è®¸åˆšç»è¿‡çš„é•¿è½¦ |
| çºµå‘ | `MAX_LONGITUDINAL` | 50.0m | è¶…è¿‡50mä¸å…³å¿ƒ |
| æ¨ªå‘ | é˜ˆå€¼ | `d_outer` (åŠ¨æ€) | ç”±èµ°å»Šè®¡ç®—å¾—å‡º |
| ç›®æ ‡è½¦é“ | åå·®é˜ˆå€¼ | `lane_width/2 + 2.5` | æ”¾å®½åŒ¹é… |

#### è½¦è¾†å°ºå¯¸ä¼°ç®—

```python
DIMENSIONS = {
    'BUS':     (6.0, 1.5),   # åŠé•¿, åŠå®½
    'VEHICLE': (2.5, 1.0),
}
```

#### è§†çº¿åˆ‡ç‚¹ç®—æ³•

æ‰¾åˆ°é®æŒ¡ç‰©é è¿‘ ego è¡Œè½¦çº¿ä¸€ä¾§çš„**åˆ‡ç‚¹** (Ghost Point)ï¼š

```python
# utils.py L897-959
# 1. è®¡ç®—é®æŒ¡ç‰©å››ä¸ªè§’ç‚¹çš„å…¨å±€åæ ‡
corners_local = [[ half_len, -half_width], [ half_len,  half_width],
                 [-half_len,  half_width], [-half_len, -half_width]]
corners_global = corners_local @ rot_matrix.T + obs_pos

# 2. è®¡ç®— egoâ†’å„è§’ç‚¹çš„è§’åº¦
relative_angles = atan2(to_corner) - ego_heading

# 3. æ ¹æ®é®æŒ¡ç‰©åœ¨ ego å·¦/å³ä¾§ï¼Œå–æœ€è¿‘çš„åˆ‡ç‚¹
cross = ego_forward Ã— vec_to_obs_center
if cross > 0:   # é®æŒ¡ç‰©åœ¨å·¦ä¾§
    ghost_point = corners[argmin(relative_angles)]  # å–å³åˆ‡ç‚¹
else:            # é®æŒ¡ç‰©åœ¨å³ä¾§
    ghost_point = corners[argmax(relative_angles)]  # å–å·¦åˆ‡ç‚¹
```

---

### 2.5 æ¨¡å—ä¸‰ï¼šTTA çŠ¶æ€æœº & æƒé‡ç³»ç»Ÿ

**æ–‡ä»¶**: [utils.py](file:///Users/phy/Desktop/MIND/planners/mind/utils.py#L682-L756) `calculate_phantom_behavior()` + L961-987 æƒé‡è®¡ç®—

#### TTA çŠ¶æ€æœº

```python
# utils.py L682-756
HUMAN_MAX_SPEED = 5.0   # äººç±»å†²åˆºé€Ÿåº¦ (m/s)
LOOKAHEAD_TIME = 1.5    # å‰ç»æ—¶é—´ (s)

tta_ego = longitudinal_dist / ego_vel   # Ego åˆ°è¾¾é¬¼ç‚¹çš„æ—¶é—´
tta_human = lateral_dist / HUMAN_MAX_SPEED  # è¡Œäººåˆ°è¾¾è½¦é“çš„æ—¶é—´
v_required = lateral_dist / tta_ego     # è¡Œäººéœ€è¦çš„é€Ÿåº¦
```

| æ¡ä»¶ | çŠ¶æ€ | å«ä¹‰ |
|------|------|------|
| `v_required > 5.0` | OBSERVE | è¡Œäººç‰©ç†ä¸Šä¸å¯èƒ½æ’ä¸Š |
| `tta_ego > 1.5s` | OBSERVE | æ—¶é—´å……è£•ï¼Œåªè§‚å¯Ÿ |
| å…¶ä»– | BRAKE + `inject_phantom=True` | è¿‘ä¸”èƒ½æ’ä¸Šï¼Œæ³¨å…¥å¹»å½± |

#### v33 æƒé‡å…¬å¼

```python
# utils.py L961-987
tta = phantom_result['tta_ego']

if tta > 5.0:
    weight = 0.0                              # å®‰å…¨åŒº
elif tta > 2.5:
    weight = 1.0 * (5.0 - tta) / 2.5        # è­¦æƒ•åŒº: 0â†’1.0
elif tta > 1.0:
    weight = 1.0 + 4.0 * (2.5 - tta) / 1.5  # å±é™©åŒº: 1.0â†’5.0
else:
    weight = 10.0                             # æå±é™©: 10.0

# çœŸé¬¼æ¢å¤´ Panic Mode
if phantom_result['inject_phantom']:
    weight *= 20.0   # Panic: 10.0Ã—20=200.0
```

**æƒé‡æ›²çº¿å›¾**ï¼š

| TTA åŒºé—´ | åç§° | æƒé‡èŒƒå›´ | v33 æ”¹åŠ¨ |
|----------|------|---------|----------|
| > 5.0s | å®‰å…¨åŒº | `0.0` | - |
| 2.5~5.0s | è­¦æƒ•åŒº | `0.0 â†’ 1.0` | ä»2.0é™åˆ°1.0 |
| 1.0~2.5s | å±é™©åŒº | `1.0 â†’ 5.0` | ä»20.0é™åˆ°5.0 |
| < 1.0s | æå±é™© | `10.0` | ä¸å˜ |
| çœŸé¬¼ Panic | Ã—20 | `æœ€é«˜ 200.0` | ä»Ã—10å‡åˆ°Ã—20 |

---

### 2.6 æ¨¡å—å››ï¼šé€Ÿåº¦æ„ŸçŸ¥é£é™©åŠ¿åœº (VelocityAwareRiskPotential)

**æ–‡ä»¶**: [potential.py](file:///Users/phy/Desktop/MIND/planners/ilqr/potential.py#L267-L428) `VelocityAwareRiskPotential`

**åŸç†**ï¼šé™æ€ CostMap æ— æ³•æä¾›é€Ÿåº¦æ¢¯åº¦ `âˆ‚C/âˆ‚v`ï¼ŒiLQR æ— æ³•"ç†è§£"å‡é€Ÿèƒ½é™ä½é£é™©ã€‚è¿™ä¸ªåŠ¿åœºé€šè¿‡**åŠ¨èƒ½æƒ©ç½š**è®© iLQR çœ‹åˆ°å‡é€Ÿçš„å¥½å¤„ã€‚

#### æ ¸å¿ƒå…¬å¼

```
Cost = W_base Ã— Sigmoid(clearance) Ã— vÂ²
```

- `clearance = |lateral_distance| - ego_half_width`ï¼šè½¦èº«è¾¹ç¼˜åˆ°é£é™©ç‚¹çš„å‡€æ¨ªå‘é—´è·
- `Sigmoid(c) = 1 / (1 + exp(k Ã— (c - ghost_lateral)))`ï¼šè¿›å…¥é£é™©åŒºæ—¶å¿«é€Ÿè¶‹è¿‘ 1
- `vÂ²`ï¼šåŠ¨èƒ½æƒ©ç½šé¡¹ï¼Œé€Ÿåº¦è¶Šé«˜ Cost è¶Šå¤§

#### æ¢¯åº¦è®¾è®¡ï¼ˆå…³é”®ï¼‰

```python
# potential.py L369-400
def get_gradient(self, state):
    gradient = np.zeros(len(state))
    if v <= 0:
        return gradient  # vâ‰¤0 (å·²åœæˆ–å€’è½¦) â†’ æ¢¯åº¦ä¸º 0 â†’ ä¸æ¨å€’è½¦
    
    # âˆ‚C/âˆ‚v = W Ã— S Ã— 2v â†’ å‘Šè¯‰ iLQR: "å‡é€Ÿå¯ä»¥é™ Cost"
    gradient[2] = w_kinetic * sig * 2.0 * v
    
    # âˆ‚C/âˆ‚x = âˆ‚C/âˆ‚y = 0 â†’ ä¸äº§ç”Ÿæ¨ªå‘æ¨åŠ› â†’ é˜²æ­¢æ‰“è½¬
    return gradient
```

> [!TIP]
> **ç©ºé—´æ¢¯åº¦è¢«æ•…æ„æ¸…é›¶** (`gradient[0] = gradient[1] = 0`)ã€‚å¦‚æœä¿ç•™ç©ºé—´æ¢¯åº¦ï¼ŒiLQR ä¼šè¯•å›¾"æ¨ªå‘èº²é¿"é£é™©åŒºï¼Œå¯¼è‡´æ–¹å‘ç›˜æ€¥æ‰“ã€‚åªä¿ç•™é€Ÿåº¦æ¢¯åº¦ `âˆ‚C/âˆ‚v` è®© iLQR é€šè¿‡å‡é€Ÿè€Œéå˜é“æ¥é™ä½é£é™©ã€‚

#### æ„é€ å‡½æ•°å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `risk_pos` | - | é£é™©ç‚¹ [x, y] |
| `lane_heading` | - | è½¦é“èˆªå‘ (rad) |
| `ghost_lateral` | 1.5m | æ¨ªå‘å±é™©é˜ˆå€¼ |
| `w_base` | ç”± TTA æƒé‡å†³å®š | åŸºç¡€æƒé‡ (0~200) |
| `lambda_v` | 0.1 | é€Ÿåº¦å¹³æ–¹ç³»æ•° |
| `ego_half_width` | 1.0m | è½¦èº«åŠå®½ |
| `k_steep` | 2.0 | Sigmoid é™¡å³­å› å­ |

---

### 2.7 æ¨¡å—äº”ï¼šiLQR Cost Tree ä¸­çš„éšœç¢ç‰©å¤„ç†

**æ–‡ä»¶**: [trajectory_tree.py](file:///Users/phy/Desktop/MIND/planners/mind/trajectory_tree.py#L58-L179) `init_cost_tree()`

**åŸç†**ï¼šå°†åœºæ™¯æ ‘ä¸­æ‰€æœ‰ exo agent çš„é¢„æµ‹è½¨è¿¹è½¬åŒ–ä¸ºæ’æ–¥åŠ›åœºï¼Œä¸ PA-LOI é£é™©åŠ¿åœºä¸€èµ·é€å…¥ iLQR ä¼˜åŒ–ã€‚

#### æ’æ–¥åŠ›åœºè®¡ç®—

```python
# trajectory_tree.py L94-109
for exo_idx in range(1, trajs.shape[0]):
    exo_mean = trajs[exo_idx, i]
    exo_cov = covs[exo_idx, i] + w_exo_cov_offset  # +2.5
    
    # è·ç¦»åœºï¼šåæ–¹å·® - åˆ°éšœç¢ç‰©çš„è·ç¦» = æ’æ–¥åŠ›
    exo_dis_field = (exo_cov - distance_to_obstacle)
    exo_dis_field = max(exo_dis_field, 0.0)          # åªåœ¨èŒƒå›´å†…æœ‰æ•ˆ
    exo_dis_field[> 0] += w_exo_cost_offset           # +10.0
    
    cov_dist_field += exo_dis_field  # ç´¯åŠ æ‰€æœ‰éšœç¢ç‰©
```

#### PA-LOI é£é™©åŠ¿åœºæ³¨å…¥

```python
# trajectory_tree.py L112-160
if risk_sources:
    for risk in risk_sources:
        risk_pot = VelocityAwareRiskPotential(
            risk_pos=risk['pos'],
            lane_heading=lane_heading,
            ghost_lateral=risk['ghost_lateral'],
            w_base=risk['weight'],    # TTA æƒé‡
            lambda_v=0.1,
            ego_half_width=1.0,
            k_steep=2.0
        )
        risk_potentials.append(risk_pot)
        # æ³¨æ„ï¼šä¸å¾€ cov_dist_field æ·»åŠ é™æ€åœºï¼Œé¿å…åŒé‡è®¡è´¹
```

#### iLQR ä¼˜åŒ–é…ç½®å‚æ•°

æ¥è‡ª [demo_2.py](file:///Users/phy/Desktop/MIND/planners/mind/configs/planning/demo_2.py)ï¼š

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `w_tgt` | 1.0 | è½¦é“ç›®æ ‡æƒé‡ |
| `w_ctrl` | 5.0 | æ§åˆ¶å¹³æ»‘æƒé‡ |
| `w_ego` | 1.0 | Ego åæ–¹å·®æƒé‡ |
| `w_ego_cov_offset` | 1.0 | Ego åæ–¹å·®åç§» |
| `w_exo` | 10.0 | éšœç¢ç‰©æ’æ–¥æ€»æƒé‡ |
| `w_exo_cov_offset` | **2.5** | æ’æ–¥åŠå¾„åç§» â¬…ï¸ **ç¢°æ’æ ¹å› ** |
| `w_exo_cost_offset` | **10.0** | æ’æ–¥åŠ›å¸¸æ•°åç§» |
| `smooth_grid_res` | 0.4 | è·ç¦»åœºç½‘æ ¼åˆ†è¾¨ç‡ (m) |
| `smooth_grid_size` | (256, 256) | è·ç¦»åœºç½‘æ ¼å°ºå¯¸ |
| é€Ÿåº¦ä¸Šé™ | 8.0 m/s | `state_upper_bound[2]` |
| é€Ÿåº¦ä¸‹é™ | 0.0 m/s | `state_lower_bound[2]` |
| åŠ é€Ÿåº¦ä¸Šé™ | 4.0 m/sÂ² | `state_upper_bound[4]` |
| åˆ¶åŠ¨ä¸Šé™ | -6.0 m/sÂ² | `state_lower_bound[4]` |
| è½¬å‘è§’ä¸Šé™ | Â±0.2 rad | `state_upper/lower_bound[5]` |

---

### 2.8 æ¨¡å—å…­ï¼šRSS-Based AEB å®‰å…¨æŠ¤ç›¾

**æ–‡ä»¶**: [planner.py](file:///Users/phy/Desktop/MIND/planners/mind/planner.py#L252-L411) (AEB æ®µ)

**åŸç†**ï¼šåŸºäº Mobileye RSS æ ‡å‡†ï¼Œç‹¬ç«‹äº iLQRï¼Œä½œä¸ºæœ€åä¸€é“å®‰å…¨é˜²çº¿ã€‚

#### RSS å®‰å…¨è·ç¦»å…¬å¼

```
d_safe = v Ã— t_response + vÂ² / (2 Ã— a_max_brake)
d_safe = max(d_safe, 2.0m)
```

| v (m/s) | d_safe (m) | è¯´æ˜ |
|---------|-----------|------|
| 2.0 | 2.0 (æœ€å°å€¼) | ä½é€Ÿæ—¶ RSS è·ç¦»å¾ˆçŸ­ |
| 3.0 | 1.73 â†’ 2.0 | è¢«æœ€å°å€¼å…œåº• |
| 4.0 | 2.80 | å¼€å§‹æœ‰æ•ˆ |
| 5.0 | 4.13 | é«˜é€Ÿæ—¶æ˜¾è‘—å¢é•¿ |
| 8.0 | 9.60 | å…¨é€Ÿæ—¶æ¥è¿‘ 10m |

#### AEB å‚æ•°

```python
# planner.py L264-271
AEB_T_RESPONSE = 0.2       # ç³»ç»Ÿå“åº”å»¶è¿Ÿ (s)
AEB_A_MAX_BRAKE = 4.0      # æœ€å¤§åˆ¶åŠ¨å‡é€Ÿåº¦ (m/sÂ²)
AEB_TTC_CRITICAL = 0.8     # å…¨åŠ›åˆ¶åŠ¨é˜ˆå€¼ (s)
AEB_TTC_DANGER = 1.6       # éƒ¨åˆ†åˆ¶åŠ¨é˜ˆå€¼ (s)
AEB_TTC_WARNING = 2.6      # é¢„è­¦å‡é€Ÿé˜ˆå€¼ (s)
AEB_LAT_STATIC = 1.2       # é™æ€éšœç¢ç‰©æ¨ªå‘é˜ˆå€¼ (m)
AEB_LAT_DYNAMIC = 1.6      # åŠ¨æ€éšœç¢ç‰©æ¨ªå‘é˜ˆå€¼ (m)
```

#### TTC è®¡ç®—

```python
# planner.py L320-331
exo_long_v = exo_vel[0] * cos_h + exo_vel[1] * sin_h  # æŠ•å½±åˆ° ego å‰å‘
approach_speed = ego_v - exo_long_v                     # æ­£å€¼ = æ¥è¿‘ä¸­
if approach_speed <= 0.01:
    continue  # æ— æ¥è¿‘é€Ÿåº¦ï¼Œæ— å¨èƒ
ttc = long_dist / approach_speed
```

#### ä¸‰çº§åˆ¶åŠ¨ç­–ç•¥

| çº§åˆ« | TTC æ¡ä»¶ | é¢å¤–æ¡ä»¶ | åˆ¶åŠ¨åŠ› | è¡Œä¸º |
|------|---------|---------|--------|------|
| WARNING | 1.6~2.6s | `long_dist < d_safe` | -0.8 m/sÂ² | ä»…è¦†ç›– iLQR åŠ é€ŸæŒ‡ä»¤ |
| DANGER | 0.8~1.6s | - | -2.0 m/sÂ² | å¼ºåˆ¶éƒ¨åˆ†åˆ¶åŠ¨ |
| CRITICAL | <0.8s | - | -4.0 m/sÂ² | å…¨åŠ›åˆ¶åŠ¨ï¼Œè¦†ç›–ä¸€åˆ‡ |

```python
# planner.py L394-406
if self.aeb_level == 'CRITICAL':
    ret_ctrl = np.array([-4.0, 0.0])     # å…¨åŠ›åˆ¶åŠ¨ + ä¸è½¬å‘
elif self.aeb_level == 'DANGER':
    ret_ctrl[0] = -2.0                    # éƒ¨åˆ†åˆ¶åŠ¨ï¼Œä¿ç•™è½¬å‘
elif self.aeb_level == 'WARNING':
    if ret_ctrl[0] > -0.8:                # ä»…è¦†ç›–åŠ é€ŸæŒ‡ä»¤
        ret_ctrl[0] = -0.8
```

#### Hysteresis çŠ¶æ€æœº

é˜²æ­¢ AEB åœ¨é˜ˆå€¼è¾¹ç•Œé¢‘ç¹åˆ‡æ¢ï¼ˆ"æŠ–åŠ¨"ï¼‰ï¼š

```mermaid
stateDiagram-v2
    [*] --> OFF
    OFF --> WARNING: TTC<2.6s & dist<d_safe
    OFF --> DANGER: TTC<1.6s
    OFF --> CRITICAL: TTC<0.8s
    WARNING --> DANGER: ç›´æ¥å‡çº§
    WARNING --> OFF: æ— å¨èƒ (ç«‹å³é‡Šæ”¾)
    DANGER --> CRITICAL: ç›´æ¥å‡çº§
    DANGER --> WARNING: éœ€è¿ç»­3å¸§ä½å¨èƒ
    CRITICAL --> DANGER: éœ€è¿ç»­3å¸§ä½å¨èƒ
    CRITICAL --> OFF: v<0.3m/s (å·²åœè½¦)
    
    note right of DANGER: åªå‡çº§ä¸é™çº§\né™çº§éœ€3å¸§å»¶è¿Ÿ
```

```python
# planner.py L350-392
# å‡çº§ï¼šç«‹å³ç”Ÿæ•ˆ
if new_priority >= current_priority:
    self.aeb_level = best_level
    self.aeb_downgrade_count = 0

# é™çº§ï¼šéœ€è¦è¿ç»­ 3 å¸§
else:
    self.aeb_downgrade_count += 1
    if self.aeb_downgrade_count >= 3:
        self.aeb_level = best_level
        self.aeb_downgrade_count = 0
```

---

### 2.9 æ¨¡å—ä¸ƒï¼šå€’è½¦ä¿æŠ¤

```python
# planner.py L407-410
if not self.aeb_active and self.state is not None:
    if self.state[2] < 0.1 and ret_ctrl[0] < 0:
        ret_ctrl[0] = 0.0  # é€Ÿåº¦â‰ˆ0æ—¶ç¦æ­¢ç»§ç»­å‡é€Ÿ
```

é˜²æ­¢ iLQR åœ¨ä½é€Ÿæ—¶è¾“å‡ºè´ŸåŠ é€Ÿåº¦å¯¼è‡´å€’è½¦ã€‚

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´å‚æ•°é€ŸæŸ¥è¡¨

### 3.1 é£é™©æ„ŸçŸ¥å‚æ•°

| å‚æ•° | ä½ç½® | å€¼ | è¯´æ˜ |
|------|------|-----|------|
| `HUMAN_MAX_SPEED` | utils.py L701 | 5.0 m/s | è¡Œäººå†²åˆºæé™ |
| `LOOKAHEAD_TIME` | utils.py L705 | 1.5s | TTA å‰ç»æ—¶é—´ |
| `STATIC_SPEED_THRES` | utils.py L805 | 0.5 m/s | é™æ­¢åˆ¤å®šé˜ˆå€¼ |
| `MAX_LONGITUDINAL` | utils.py L806 | 50.0m | æœ€å¤§æ£€æµ‹çºµå‘è·ç¦» |
| `sigma` (risk_cov) | utils.py L990 | 0.8 | é£é™©é«˜æ–¯åŠå¾„ |
| Panic Multiplier | utils.py L987 | Ã—20 | çœŸé¬¼æ¢å¤´æƒé‡æ”¾å¤§ |

### 3.2 iLQR ä¼˜åŒ–å‚æ•°

| å‚æ•° | ä½ç½® | å€¼ |
|------|------|-----|
| `w_tgt` | demo_2.py L72 | 1.0 |
| `w_ctrl` | demo_2.py L70 | 5.0 |
| `w_exo` | demo_2.py L81 | 10.0 |
| `w_exo_cov_offset` | demo_2.py L82 | 2.5 |
| `w_exo_cost_offset` | demo_2.py L83 | 10.0 |
| `w_ego_cov_offset` | demo_2.py L78 | 1.0 |

### 3.3 AEB å‚æ•°

| å‚æ•° | ä½ç½® | å€¼ |
|------|------|-----|
| `AEB_T_RESPONSE` | planner.py L265 | 0.2s |
| `AEB_A_MAX_BRAKE` | planner.py L266 | 4.0 m/sÂ² |
| `AEB_TTC_CRITICAL` | planner.py L267 | 0.8s |
| `AEB_TTC_DANGER` | planner.py L268 | 1.6s |
| `AEB_TTC_WARNING` | planner.py L269 | 2.6s |
| `AEB_LAT_STATIC` | planner.py L270 | 1.2m |
| `AEB_LAT_DYNAMIC` | planner.py L271 | 1.6m |
| Hysteresis é™çº§å¸§æ•° | planner.py L366 | 3 |

### 3.4 VelocityAwareRiskPotential å‚æ•°

| å‚æ•° | ä½ç½® | å€¼ |
|------|------|-----|
| `lambda_v` | potential.py L291 | 0.1 |
| `ego_half_width` | potential.py L292 | 1.0m |
| `k_steep` | potential.py L293 | 2.0 |

---

## ç¬¬å››éƒ¨åˆ†ï¼šè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šAEB å®‰å…¨å…œåº•ï¼ˆæœ€ä½é£é™©ï¼‰

å·²å®ç°çš„ RSS AEB åœ¨ TTC<2.6s æ—¶è‡ªåŠ¨ä»‹å…¥ã€‚ä»¥æœ¬æ¬¡ç¢°æ’ä¸ºä¾‹ï¼š

```
long_dist=7.5m, v=4.78m/s â†’ TTC=7.5/4.78=1.57s â†’ DANGER çº§åˆ¶åŠ¨ (-2.0 m/sÂ²)
```

### æ–¹æ¡ˆ Bï¼šå¢å¤§æ’æ–¥å‚æ•°

```diff
# demo_2.py
- self.opt_cfg['w_exo_cov_offset'] = 2.5
+ self.opt_cfg['w_exo_cov_offset'] = 4.0
- self.opt_cfg['w_exo_cost_offset'] = 10.0
+ self.opt_cfg['w_exo_cost_offset'] = 20.0
```

### æ–¹æ¡ˆ Cï¼šA + B ç»„åˆï¼ˆæ¨èï¼‰

é€‚åº¦å¢å¤§æ’æ–¥åŠ› + AEB å…œåº•ã€‚
